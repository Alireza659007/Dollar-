<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>پنل امتیاز و مدیریت دلار</title>
<style>
  body {
    font-family: Tahoma, sans-serif;
    background: linear-gradient(135deg, #004d00, #660066);
    color: white;
    margin: 0; padding: 0;
    display: flex;
    justify-content: center;
  }
  #container {
    max-width: 800px;
    width: 100%;
    background: #1a1a1a;
    padding: 20px;
    border-radius: 10px;
    margin: 20px;
  }
  h2 {
    text-align: center;
    margin-bottom: 10px;
  }
  input, button {
    padding: 8px;
    margin: 5px 0;
    width: 100%;
    border-radius: 5px;
    border: none;
    font-size: 1rem;
  }
  button {
    cursor: pointer;
    background: #00cc44;
    color: white;
    font-weight: bold;
  }
  button:hover {
    background: #009933;
  }
  table {
    width: 100%;
    margin-top: 10px;
    border-collapse: collapse;
  }
  th, td {
    padding: 8px;
    border-bottom: 1px solid #333;
    text-align: center;
  }
  th {
    background: #660066;
  }
  #messages {
    margin: 10px 0;
    min-height: 20px;
    color: #ffcc00;
  }
  .hidden {
    display: none;
  }
  #adminPanel {
    background: #660066;
    padding: 10px;
    border-radius: 8px;
    margin-top: 20px;
  }
  #adminPanel input, #adminPanel button {
    width: auto;
    margin-right: 10px;
  }
</style>
</head>
<body>
  <div id="container">

    <!-- ثبت نام -->
    <div id="registerDiv">
      <h2>ثبت نام</h2>
      <input id="regUser" placeholder="نام کاربری" />
      <input id="regPass" type="password" placeholder="رمز عبور" />
      <button onclick="registerUser()">ثبت نام</button>
      <p id="regMsg"></p>
      <hr />
    </div>

    <!-- ورود -->
    <div id="loginDiv">
      <h2>ورود</h2>
      <input id="loginUser" placeholder="نام کاربری" />
      <input id="loginPass" type="password" placeholder="رمز عبور" />
      <button onclick="loginUser()">ورود</button>
      <p id="loginMsg"></p>
      <hr />
    </div>

    <!-- صفحه اصلی بعد ورود -->
    <div id="mainDiv" class="hidden">
      <h2>خوش آمدید: <span id="currentUserName"></span></h2>
      <p>موجودی دلار شما: <span id="userBalance"></span>$</p>

      <!-- انتقال دلار -->
      <h3>انتقال دلار به کاربر دیگر</h3>
      <input id="transferTo" placeholder="نام کاربری مقصد" />
      <input id="transferAmount" type="number" placeholder="مقدار دلار" min="1" />
      <button onclick="transferDollar()">انتقال</button>
      <p id="transferMsg"></p>

      <!-- جدول امتیازات -->
      <h3>۱۰ نفر برتر</h3>
      <table>
        <thead>
          <tr><th>رتبه</th><th>نام کاربری</th><th>موجودی دلار</th></tr>
        </thead>
        <tbody id="scoreTable"></tbody>
      </table>

      <button onclick="logout()">خروج</button>
    </div>

    <!-- پنل مدیریت -->
    <div id="adminLoginDiv" class="hidden">
      <h2>ورود پنل مدیریت</h2>
      <input id="adminPass" type="password" placeholder="رمز پنل مدیریت" />
      <button onclick="adminLogin()">ورود مدیریت</button>
      <p id="adminLoginMsg"></p>
    </div>

    <div id="adminPanel" class="hidden">
      <h2>پنل مدیریت</h2>

      <h3>افزودن دلار با کد یکبار مصرف</h3>
      <input id="codeInput" placeholder="کد یکبار مصرف" />
      <input id="codeAmount" type="number" placeholder="مقدار دلار برای کد" min="1" />
      <button onclick="addCode()">افزودن کد</button>
      <p id="codeMsg"></p>

      <h3>استفاده از کد برای افزایش دلار</h3>
      <input id="useCodeInput" placeholder="کد استفاده" />
      <button onclick="useCode()">استفاده از کد</button>
      <p id="useCodeMsg"></p>

      <h3>حذف کاربر</h3>
      <input id="delUserInput" placeholder="نام کاربری برای حذف" />
      <button onclick="deleteUser()">حذف کاربر</button>
      <p id="delUserMsg"></p>

      <button onclick="adminLogout()">خروج از پنل مدیریت</button>
    </div>

  </div>

<script>
  // داده‌ها از localStorage
  let users = JSON.parse(localStorage.getItem("users") || "{}");
  let currentUser = localStorage.getItem("currentUser") || null;
  let adminLoggedIn = false;

  // کدهای یکبار مصرف: {code: amount}
  let codes = JSON.parse(localStorage.getItem("codes") || "{}");

  // ذخیره‌سازی داده‌ها
  function saveData() {
    localStorage.setItem("users", JSON.stringify(users));
    localStorage.setItem("codes", JSON.stringify(codes));
  }

  // ثبت نام
  function registerUser() {
    const u = document.getElementById("regUser").value.trim();
    const p = document.getElementById("regPass").value;
    const msg = document.getElementById("regMsg");

    if(!u || !p) {
      msg.innerText = "نام کاربری و رمز عبور را وارد کنید";
      return;
    }
    if(users[u]) {
      msg.innerText = "نام کاربری موجود است";
      return;
    }
    users[u] = { password: p, balance: 0, usedCodes: [] };
    saveData();
    msg.style.color = "lightgreen";
    msg.innerText = "ثبت نام موفق! اکنون وارد شوید.";
    document.getElementById("regUser").value = "";
    document.getElementById("regPass").value = "";
  }

  // ورود کاربر
  function loginUser() {
    const u = document.getElementById("loginUser").value.trim();
    const p = document.getElementById("loginPass").value;
    const msg = document.getElementById("loginMsg");

    if(!users[u]) {
      msg.innerText = "نام کاربری وجود ندارد";
      return;
    }
    if(users[u].password !== p) {
      msg.innerText = "رمز عبور اشتباه است";
      return;
    }
    currentUser = u;
    localStorage.setItem("currentUser", currentUser);
    msg.innerText = "";
    showMainPage();
  }

  // نمایش صفحه اصلی کاربر
  function showMainPage() {
    document.getElementById("registerDiv").classList.add("hidden");
    document.getElementById("loginDiv").classList.add("hidden");
    document.getElementById("mainDiv").classList.remove("hidden");
    document.getElementById("adminLoginDiv").classList.remove("hidden");
    updateUserInfo();
    updateTable();
  }

  // به‌روزرسانی اطلاعات کاربر و موجودی
  function updateUserInfo() {
    document.getElementById("currentUserName").innerText = currentUser;
    document.getElementById("userBalance").innerText = users[currentUser].balance;
  }

  // خروج کاربر
  function logout() {
    currentUser = null;
    localStorage.removeItem("currentUser");
    document.getElementById("mainDiv").classList.add("hidden");
    document.getElementById("registerDiv").classList.remove("hidden");
    document.getElementById("loginDiv").classList.remove("hidden");
    document.getElementById("adminLoginDiv").classList.add("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
  }

  // انتقال دلار به کاربر دیگر
  function transferDollar() {
    const to = document.getElementById("transferTo").value.trim();
    const amt = parseInt(document.getElementById("transferAmount").value);
    const msg = document.getElementById("transferMsg");

    if(!to || !amt || amt <= 0) {
      msg.innerText = "نام کاربری مقصد و مقدار معتبر را وارد کنید";
      return;
    }
    if(!users[to]) {
      msg.innerText = "کاربر مقصد وجود ندارد";
      return;
    }
    if(users[currentUser].balance < amt) {
      msg.innerText = "موجودی کافی نیست";
      return;
    }
    if(to === currentUser) {
      msg.innerText = "نمیتوان به خودتان دلار منتقل کنید";
      return;
    }

    users[currentUser].balance -= amt;
    users[to].balance += amt;
    saveData();
    updateUserInfo();
    updateTable();
    msg.style.color = "lightgreen";
    msg.innerText = `انتقال موفق: ${amt}$ به ${to}`;
    document.getElementById("transferTo").value = "";
    document.getElementById("transferAmount").value = "";
  }

  // بروزرسانی جدول ۱۰ نفر برتر
  function updateTable() {
    const tbody = document.getElementById("scoreTable");
    tbody.innerHTML = "";

    // مرتب سازی کاربران بر اساس موجودی
    const sortedUsers = Object.entries(users)
      .sort((a,b) => b[1].balance - a[1].balance)
      .slice(0,10);

    sortedUsers.forEach(([username, data], index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${index + 1}</td><td>${username}</td><td>${data.balance}$</td>`;
      tbody.appendChild(tr);
    });
  }

  // ورود پنل مدیریت
  function adminLogin() {
    const pass = document.getElementById("adminPass").value;
    const msg = document.getElementById("adminLoginMsg");
    if(pass === "admin123") {
      adminLoggedIn = true;
      document.getElementById("adminPanel").classList.remove("hidden");
      document.getElementById("adminLoginDiv").classList.add("hidden");
      msg.innerText = "";
      document.getElementById("adminPass").value = "";
    } else {
      msg.innerText = "رمز پنل مدیریت اشتباه است";
    }
  }

  // خروج پنل مدیریت
  function adminLogout() {
    adminLoggedIn = false;
    document.getElementById("adminPanel").classList.add("hidden");
    document.getElementById("adminLoginDiv").classList.remove("hidden");
  }

  // افزودن کد یکبار مصرف در پنل مدیریت
  function addCode() {
    const code = document.getElementById("codeInput").value.trim();
    const amount = parseInt(document.getElementById("codeAmount").value);
    const msg = document.getElementById("codeMsg");

    if(!adminLoggedIn) {
      msg.innerText = "ابتدا وارد پنل مدیریت شوید";
      return;
    }
    if(!code || !amount || amount <= 0) {
      msg.innerText = "کد و مقدار معتبر وارد کنید";
      return;
    }
    if(codes[code]) {
      msg.innerText = "این کد قبلا اضافه شده";
      return;
    }

    codes[code] = amount;
    saveData();
    msg.style.color = "lightgreen";
    msg.innerText = `کد ${code} با مقدار ${amount}$ اضافه شد`;
    document.getElementById("codeInput").value = "";
    document.getElementById("codeAmount").value = "";
  }

  // استفاده از کد برای افزایش دلار کاربر
  function useCode() {
    const code = document.getElementById("useCodeInput").value.trim();
    const msg = document.getElementById("useCodeMsg");

    if(!currentUser) {
      msg.innerText = "ابتدا وارد سایت شوید";
      return;
    }
    if(!code) {
      msg.innerText = "کد را وارد کنید";
      return;
    }
    if(!codes[code]) {
      msg.innerText = "کد نامعتبر است یا استفاده شده";
      return;
    }
    if(users[currentUser].usedCodes && users[currentUser].usedCodes.includes(code)) {
      msg.innerText = "شما قبلا از این کد استفاده کرده‌اید";
      return;
    }

    users[currentUser].balance += codes[code];
    if(!users[currentUser].usedCodes) users[currentUser].usedCodes = [];
    users[currentUser].usedCodes.push(code);
    delete codes[code]; // کد یکبار مصرف است، حذف شود
    saveData();
    updateUserInfo();
    updateTable();

    msg.style.color = "lightgreen";
    msg.innerText = `مقدار ${users[currentUser].balance}$ به موجودی شما اضافه شد`;
    document.getElementById("useCodeInput").value = "";
  }

  // حذف کاربر در پنل مدیریت
  function deleteUser() {
    if(!adminLoggedIn) {
      document.getElementById("delUserMsg").innerText = "ابتدا وارد پنل مدیریت شوید";
      return;
    }
    const u = document.getElementById("delUserInput").value.trim();
    const msg = document.getElementById("delUserMsg");

    if(!users[u]) {
      msg.innerText = "کاربر وجود ندارد";
      return;
    }
    if(u === currentUser) {
      msg.innerText = "نمی‌توانید خود را حذف کنید";
      return;
    }

    delete users[u];
    saveData();
    updateTable();

    msg.style.color = "lightgreen";
    msg.innerText = `کاربر ${u} حذف شد`;
    document.getElementById("delUserInput").value = "";
  }

  // اگر کاربر لاگین بود، صفحه اصلی را نشان بده
  if(currentUser && users[currentUser]) {
    showMainPage();
  }

</script>
</body>
</html>
